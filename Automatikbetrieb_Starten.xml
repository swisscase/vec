<?xml version="1.0" encoding="UTF-8"?>
<xmlscript desc="Automatikbetrieb_Starten.xml">

	<trace text="Automatikbetrieb: Starte Automatikbetrieb. Bitte warten..."/>
	
	<!-------Variablen Deklarieren----->
	<vr id="AutomatikUmschaltenFehlerWennNull" value="1"/> 
	<vr id="LokFalschPlatziertWennNull" value="1"/> 
	
	
	<!-------Prüfe jedes Element in der Fahrstrassenliste. Falls eine Fahrstrasse gelockt ist, Setze ein Flag.----->
	<foreach table="stlist" state="st %oid% = locked" alltrue="true">
		<vr id="AutomatikUmschaltenFehlerWennNull" value="0"/> 
	</foreach>
	
	
	<if condition="#AutomatikUmschaltenFehlerWennNull = 0">
		<then>
			<tx id="InfoBox" format="Automatikbetrieb:|Abbruch Automatkbetrieb.|Eine Fahrstrasse war noch|nicht freigegeben"/>
			<model cmd="modify">
				<tx id="InfoBox" backred="255" backgreen="0" backblue="0"/>
			</model>
			<trace text="Automatikbetrieb: Abbruch Automatkbetrieb. Eine Fahrstrasse war noch nicht freigegeben"/>
			<break cmt=""/>
		</then>
		
		<else>
			<!-------Prüfe ob die Fahrtrichtung korrekt ist. Falls nicht. Setze ein Fehler Flag----->
			<foreach table="lclist">
				<if state="lc %oid% = E0_Gl.8|lc %oid% = E0_Gl.7|lc %oid% = Virtuell_G7_Gl371" alltrue="false">
					<then>
						<if state="lc %lcid% = +">
							<then>
								<trace text="Automatikbetrieb: Die %lcid% ist in eine falsche Richtung platziert" />
								<vr id="LokFalschPlatziertWennNull" value="0"/> 
							</then>	
						</if>
					</then>
			   </if>
			</foreach>
			
			<foreach table="lclist">
				<if state="lc %oid% = E0_Gl.6|lc %oid% = E0_Gl.5|lc %oid% = E0_Gl.4|lc %oid% = Virtuell_Gl5_Gl452" alltrue="false">
					<then>
						<if state="lc %lcid% = -">
							<then>
								<trace text="Automatikbetrieb: Die %lcid% ist in eine falsche Richtung platziert" />
								<vr id="LokFalschPlatziertWennNull" value="0"/> 
							</then>	
						</if>
					</then>
			   </if>
			</foreach>
			
			<!-------Prüfen ob ein Fehler existiert----->
			<if condition="#LokFalschPlatziertWennNull = 0">
				<then>
					<!-------Fehlerfall----->
					<trace text="Automatikbetrieb: Abbruch Automatkbetrieb da eine Lok falsch platziert ist." />
					<tx id="InfoBox" format="Automatikbetrieb:|Abbruch Automatikbetrieb.|Ein Zug in den Bahnhöfen ist|in eine falsche Richtung|platziert"/>
					<model cmd="modify">
						<tx id="InfoBox" backred="255" backgreen="0" backblue="0"/>
					</model>
					
					<sleep time="5000"/>

					<model cmd="modify">
						<tx id="InfoBox" backred="255" backgreen="255" backblue="255"/>
					</model>
					<actionctrl id="Akt_textupdate_Infobox_Digitalbetrieb">
						<actioncond id="R_Dig_Analog" subid="" state="on" type="fb"/>
					</actionctrl>
					
				</then>
				<else>
					<!-------Kein Fehler, alles IO. Wechsle in den Automatikbetrieb----->
					<trace text="Automatikbetrieb: Starte Weichensperrung."/>
					<sw id="E-1_W17" cmd="straight"/> 
					<sw id="E-1_W17" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="E-2_W11" cmd="straight"/> 
					<sw id="E-2_W11" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="W415" cmd="straight"/> 
					<sw id="W415" cmd="setstatic"/> 
					<sleep time="200"/>
					<sw id="W415b" cmd="straight"/> 
					<sw id="W415b" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="W467" cmd="straight"/> 
					<sw id="W467" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="W360" cmd="straight"/> 
					<sw id="W360" cmd="setstatic"/>
					<sleep time="200"/>			
					<sw id="W367" cmd="straight"/> 
					<sw id="W367" cmd="setstatic"/> 
					<sleep time="200"/>
					<sw id="W9-17a" cmd="straight"/> 
					<sw id="W9-17a" cmd="setstatic"/> 
					<sleep time="200"/>
					<sw id="W9-17b" cmd="straight"/> 
					<sw id="W9-17b" cmd="setstatic"/> 
					<sleep time="200"/>
					<sw id="W10-16a" cmd="straight"/> 
					<sw id="W10-16a" cmd="setstatic"/>
					<sleep time="200"/>			
					<sw id="W10-16b" cmd="straight"/> 
					<sw id="W10-16b" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="W7-19a" cmd="straight"/> 
					<sw id="W7-19a" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="W7-19b" cmd="straight"/> 
					<sw id="W7-19b" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="W6-20a" cmd="straight"/> 
					<sw id="W6-20a" cmd="setstatic"/>
					<sleep time="200"/>
					<sw id="W6-20b" cmd="straight"/> 
					<sw id="W6-20b" cmd="setstatic"/>
					<sleep time="200"/>
					
					<trace text="Automatikbetrieb: Weichensperrung abgeschlossen."/>
				
					<!-------Starte die Züge in den Blöcken----->
					<foreach table="lclist">
						<lc cmd="govirtual"/>
						<trace text="Automatikbetrieb: Starte Lok %oid%"/>
						<sleep time="200"/>	
					</foreach>
					<trace text="Automatikbetrieb: Automatikbetrieb gestartet"/>
					<model cmd="modify">
						<tx id="InfoBox" backred="255" backgreen="255" backblue="255"/>
					</model>
					<tx id="InfoBox" format="Automatikbetrieb gestartet.|Die Züge fahren vollautomatisch."/>
				</else>		
				
			</if>

		</else>
	</if>			
	

</xmlscript>